{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///Users/javiermayorga/Documents/repos/v0-amazonico-landing-page/app/api/wompi/create-session/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from 'next/server'\n\nexport async function POST(request: NextRequest) {\n  try {\n    const body = await request.json()\n    \n    // Validar solo datos mínimos requeridos - Wompi pedirá el resto\n    if (!body.amount) {\n      return NextResponse.json(\n        { error: 'El monto es requerido' },\n        { status: 400 }\n      )\n    }\n\n    // Credenciales de Wompi (deben estar en variables de entorno)\n    const WOMPI_PUBLIC_KEY = process.env.NEXT_PUBLIC_WOMPI_PUBLIC_KEY\n    const WOMPI_PRIVATE_KEY = process.env.WOMPI_PRIVATE_KEY\n    const WOMPI_INTEGRITY_KEY = process.env.WOMPI_INTEGRITY_KEY\n    const WOMPI_ENVIRONMENT = process.env.WOMPI_ENVIRONMENT || 'test' // 'test' o 'production'\n\n    if (!WOMPI_PUBLIC_KEY || !WOMPI_PRIVATE_KEY) {\n      return NextResponse.json(\n        { error: 'Configuración de Wompi incompleta' },\n        { status: 500 }\n      )\n    }\n\n    const baseUrl = WOMPI_ENVIRONMENT === 'production' \n      ? 'https://production.wompi.co/v1'\n      : 'https://sandbox.wompi.co/v1'\n\n    // Crear referencia única\n    const reference = body.reference || `AMAZONIICO-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`\n\n    // Descripción del producto\n    const description = body.description || 'Amazoniico Colágeno Marino'\n\n    // Validar que el monto sea válido\n    const amountInCents = Math.round(body.amount * 100)\n    if (amountInCents <= 0 || isNaN(amountInCents)) {\n      return NextResponse.json(\n        { error: 'El monto debe ser mayor a 0' },\n        { status: 400 }\n      )\n    }\n\n    // Preparar datos para crear payment link en Wompi\n    // Estructura según documentación de Wompi payment_links\n    const checkoutData: any = {\n      name: body.productName || 'Amazoniico Colágeno Marino', // Nombre (requerido para payment_links)\n      description: description.substring(0, 300), // Descripción (requerido)\n      single_use: false, // Permitir múltiples usos\n      collect_shipping: true, // Recolectar datos de envío\n      currency: body.currency || 'COP', // Moneda (requerido)\n      amount_in_cents: amountInCents, // Monto en centavos (requerido)\n      redirect_url: `${process.env.NEXT_PUBLIC_SITE_URL || 'http://localhost:3000'}/checkout/success?reference=${encodeURIComponent(reference)}`,\n    }\n\n    // Agregar customer_data opcional si se proporciona (para pre-llenar formulario)\n    if (body.email || body.name) {\n      checkoutData.customer_data = {}\n      if (body.email) {\n        checkoutData.customer_data.email = body.email\n      }\n      if (body.name) {\n        checkoutData.customer_data['full-name'] = body.name\n      }\n    }\n\n    // Agregar meta con información del producto si está disponible\n    if (body.items) {\n      checkoutData.meta = {\n        items: JSON.stringify(body.items),\n        reference: reference\n      }\n    }\n\n    console.log('Enviando a Wompi:', {\n      url: `${baseUrl}/payment_links`,\n      data: { ...checkoutData, amount_in_cents: checkoutData.amount_in_cents }\n    })\n\n    // Crear payment link en Wompi (el endpoint correcto)\n    const wompiResponse = await fetch(`${baseUrl}/payment_links`, {\n      method: 'POST',\n      headers: {\n        'Content-Type': 'application/json',\n        'Authorization': `Bearer ${WOMPI_PRIVATE_KEY}`,\n      },\n      body: JSON.stringify(checkoutData),\n    })\n\n    if (!wompiResponse.ok) {\n      let errorData: any = {}\n      let errorText = ''\n      \n      try {\n        errorText = await wompiResponse.text()\n        errorData = JSON.parse(errorText)\n      } catch (e) {\n        errorData = { raw: errorText }\n      }\n      \n      console.error('Error de Wompi:', {\n        status: wompiResponse.status,\n        statusText: wompiResponse.statusText,\n        error: errorData,\n        errorText: errorText,\n        requestData: checkoutData\n      })\n      \n      // Extraer mensaje de error más descriptivo de diferentes formatos posibles\n      const errorMessage = errorData?.error?.message || \n                          errorData?.error?.reason ||\n                          errorData?.message || \n                          errorData?.error?.type ||\n                          errorData?.error?.code ||\n                          errorText ||\n                          `Error ${wompiResponse.status}: ${wompiResponse.statusText}`\n      \n      return NextResponse.json(\n        { \n          error: 'Error al crear sesión de pago en Wompi',\n          message: errorMessage,\n          details: errorData,\n          status: wompiResponse.status,\n          statusText: wompiResponse.statusText\n        },\n        { status: wompiResponse.status }\n      )\n    }\n\n    const wompiData = await wompiResponse.json()\n\n    console.log('Respuesta de Wompi:', wompiData)\n\n    // Extraer el ID del payment link de la respuesta\n    const paymentLinkId = wompiData.data?.id || wompiData.id\n    \n    // Validar que recibimos el ID\n    if (!paymentLinkId) {\n      console.error('Respuesta de Wompi sin ID:', wompiData)\n      return NextResponse.json(\n        { error: 'No se recibió el ID del payment link de Wompi' },\n        { status: 500 }\n      )\n    }\n\n    // Construir el permalink manualmente según documentación de Wompi\n    // Estructura: https://checkout.wompi.co/l/{PAYMENT_LINK_ID}\n    const checkoutUrl = `https://checkout.wompi.co/l/${paymentLinkId}`\n\n    console.log('Payment link creado exitosamente:', {\n      id: paymentLinkId,\n      url: checkoutUrl,\n      reference\n    })\n\n    // Retornar URL de checkout construida manualmente\n    return NextResponse.json({\n      checkoutUrl,\n      reference,\n      sessionId: paymentLinkId,\n    })\n  } catch (error) {\n    console.error('Error en create-session:', error)\n    return NextResponse.json(\n      { error: 'Error interno del servidor' },\n      { status: 500 }\n    )\n  }\n}\n\n"],"names":[],"mappings":"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"}}]
}